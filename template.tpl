___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "User Distributor",
  "description": "Distribute users to groups based on a percentage split, and store this information in a cookie.",
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1VzZXJEaXN0cmlidXRvci1TaW1vLUFoYXZh",
  "securityGroups": [],
  "categories": [
    "UTILITY",
    "ANALYTICS",
    "EXPERIMENTATION"
  ],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/jpeg;base64,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zuATjCMe2QK+WocTY2lgo4OOEqe3S5V7vu3Ste/49vPqfPUs/wAXTwiwscNP2yVttL7Xv+PbzPvD9m/9ofUfj4ddml8PDRrXRvsyCYXJnEss+8lP9WmNqqCev3hX1HXlPwZ+Eug/BjwRbeD9DYzuGM97duNr3Vy4AeQjsMAKq54UAdck+rV9rlNPFQwkI42XNUtq9N+2mmmx9XlsMTHDQWLlep12+7TtsFFFFeidx//Q/fyiiigAooooAKKKKACvOfi/4JuviV8KvF/w9sbmOzuPEmiX+lRXEoLRxPdwvErsF5IUtkgc16NRQB8GfsMfsieJP2TdI8X6b4i1+y11vEl1YzxNZRSRCIWkcqEN5nUsZBjHpX3nRRQAUUUUAFFFFABRRRQB+Yf7TX7Bfi747/tHaL8btJ8Uadpdjpcejo9jcQyvM/8AZlw0z4ZBt+cNgeh61+nlFFABRRRQAUUUUAFFFFABRRRQB//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Z",
    "displayName": "gtm-templates-simo-ahava",
    "id": "github.com_gtm-templates-simo-ahava"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "displayName": "Distribution type",
    "simpleValueType": true,
    "name": "splitType",
    "type": "RADIO",
    "radioItems": [
      {
        "displayValue": "Single (for e.g. sampling)",
        "value": "single"
      },
      {
        "displayValue": "Multi (for e.g. split testing)",
        "value": "multi"
      }
    ]
  },
  {
    "help": "When you add a number to the field, that is the probability of any user for whom the tag fires to be included in the group. This is indicated by having the string \u003cstrong\u003etrue\u003c/strong\u003e as the value of the cookie. If the user is not included in the group, the cookie will be written with the value \u003cstrong\u003efalse\u003c/strong\u003e.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "args": [
          "^(100|[1-9][0-9]|[1-9])$"
        ],
        "errorMessage": "The value must be a number between 1 and 100 (inclusive).",
        "type": "REGEX"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "splitType",
        "type": "EQUALS",
        "paramValue": "single"
      }
    ],
    "displayName": "Probability of being included",
    "simpleValueType": true,
    "name": "singlePercent",
    "valueUnit": "%",
    "type": "TEXT",
    "valueHint": "e.g. 10"
  },
  {
    "help": "Add each group you want to include in the distribution as its own row. Set the \u003cstrong\u003eGroup value\u003c/strong\u003e field to the value of the cookie you want to set for users who are included in this group. Set the \u003cstrong\u003eDistribution\u003c/strong\u003e as the probability weight (out of 100) of being included in the group.\n\u003cbr/\u003e\u003cbr/\u003e\nThe distribution probabilities should not exceed 100 when summed together. The sum can be less than 100 - in case a user doesn\u0027t have a group, the cookie is not set.",
    "enablingConditions": [
      {
        "paramName": "splitType",
        "type": "EQUALS",
        "paramValue": "multi"
      }
    ],
    "displayName": "Multiple groups",
    "name": "multiPercent",
    "simpleTableColumns": [
      {
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "",
        "displayName": "Group value",
        "name": "value",
        "isUnique": true,
        "type": "TEXT",
        "valueHint": "e.g. variation1"
      },
      {
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "args": [
              "^(100|[1-9][0-9]|[1-9])$"
            ],
            "errorMessage": "The value must be a number between 1 and 100 (inclusive).",
            "type": "REGEX"
          }
        ],
        "defaultValue": "",
        "displayName": "Distribution",
        "name": "probability",
        "type": "TEXT",
        "valueHint": "e.g. 25"
      }
    ],
    "type": "SIMPLE_TABLE",
    "newRowButtonText": "New group"
  },
  {
    "displayName": "Cookie settings",
    "name": "cookieSettings",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "If you change this from the default, you \u003cstrong\u003emust\u003c/strong\u003e edit the Permissions of the tag template accordingly.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "Cookie name",
        "defaultValue": "_gtm_group",
        "simpleValueType": true,
        "name": "cookieName",
        "type": "TEXT"
      },
      {
        "help": "Set to \u003cstrong\u003eauto\u003c/strong\u003e to write the cookie on the broadest domain name possible.",
        "displayName": "Cookie domain",
        "defaultValue": "auto",
        "simpleValueType": true,
        "name": "cookieDomain",
        "type": "TEXT"
      },
      {
        "displayName": "Cookie maximum age (in days)",
        "defaultValue": 365,
        "simpleValueType": true,
        "name": "cookieExpires",
        "valueUnit": "days",
        "type": "TEXT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const setCookie = require('setCookie');
const readCookie = require('getCookieValues');
const generateRandom = require('generateRandom');
const makeInteger = require('makeInteger');
const log = require('logToConsole');

// Percentage accumulation for multi
let acc = 0;

// Randomizer
const rand = generateRandom(1, 100);

// User data
const cookieName = data.cookieName;
const cookieDomain = data.cookieDomain;
const cookieMaxAge = data.cookieExpires * 24 * 60 * 60;
const single = data.singlePercent;
const multi = data.multiPercent;

// Only run if cookie is not set
if (readCookie(cookieName).length === 0) {

  // If single distribution
  if (single) {
    setCookie(
      cookieName,
      (rand <= single ? 'true' : 'false'),
      {
        domain: cookieDomain,
        'max-age': cookieMaxAge
      }
    );
  }

  // If multi distribution
  if (multi) {
    multi.some(obj => {
      acc += makeInteger(obj.probability);
      if (rand <= acc) {
        setCookie(
          cookieName,
          obj.value,
          {
            domain: cookieDomain,
            'max-age': cookieMaxAge
          }
        );
        return true;
      }
    });
  }

}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_gtm_group"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_gtm_group"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Do nothing if cookie exists
  code: |-
    mock('getCookieValues', [true]);

    // Call runCode to run the template's code.
    runCode(mockSingleData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasNotCalled();
    assertApi('setCookie').wasNotCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set single cookie to true when in distribution
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 50);
    mock('setCookie', (name, value, options) => {
      if (value !== 'true') {
        fail('setCookie not called with "true"');
      }
    });

    // Call runCode to run the template's code.
    runCode(mockSingleData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasNotCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set single cookie to false when not in distribution
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 51);
    mock('setCookie', (name, value, options) => {
      if (value !== 'false') {
        fail('setCookie not called with "false"');
      }
    });

    // Call runCode to run the template's code.
    runCode(mockSingleData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasNotCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set single cookie with correct options
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 99);
    mock('setCookie', (name, value, options) => {
      if (name !== mockSingleData.cookieName) fail('setCookie called with incorrect cookie name');
      if (value !== 'false') fail('setCookie not called with "false"');
      if (options.domain !== mockSingleData.cookieDomain) fail('setCookie called with incorrect cookie domain');
      if (options['max-age'] !== mockSingleData.cookieExpires * 24 * 60 * 60) fail('setCookie called with incorrect max-age');
    });

    // Call runCode to run the template's code.
    runCode(mockSingleData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasNotCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set multi cookie to A when equal to 33
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 33);
    mock('setCookie', (name, value, options) => {
      if (value !== 'A') {
        fail('setCookie not called with "A"');
      }
    });

    // Call runCode to run the template's code.
    runCode(mockMultiData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set multi cookie to B when equal to 34
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 34);
    mock('setCookie', (name, value, options) => {
      if (value !== 'B') {
        fail('setCookie not called with "B"');
      }
    });

    // Call runCode to run the template's code.
    runCode(mockMultiData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Do not set multi cookie if not within distributions
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 67);
    mock('setCookie', (name, value, options) => {
      fail('setCookie should not have been called');
    });

    // Call runCode to run the template's code.
    runCode(mockMultiData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasCalled();
    assertApi('setCookie').wasNotCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Set multi cookie with correct options
  code: |-
    mock('getCookieValues', []);
    mock('generateRandom', 20);
    mock('setCookie', (name, value, options) => {
      if (name !== mockMultiData.cookieName) fail('setCookie called with incorrect cookie name');
      if (value !== mockMultiData.multiPercent[0].value) fail('setCookie called with incorrect cookie value');
      if (options.domain !== mockMultiData.cookieDomain) fail('setCookie called with incorrect cookie domain');
      if (options['max-age'] !== mockMultiData.cookieExpires * 24 * 60 * 60) fail('setCookie called with incorrect max-age');
    });

    // Call runCode to run the template's code.
    runCode(mockMultiData);

    assertApi('generateRandom').wasCalled();
    assertApi('getCookieValues').wasCalled();
    assertApi('makeInteger').wasCalled();
    assertApi('setCookie').wasCalled();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: |-
  const mockSingleData = {
    cookieName: 'userDistributor',
    cookieDomain: 'auto',
    cookieExpires: 365,
    singlePercent: 50
  };

  const mockMultiData = {
    cookieName: 'userDistributor',
    cookieDomain: 'auto',
    cookieExpires: 365,
    multiPercent: [{
      value: 'A',
      probability: 33
    },{
      value: 'B',
      probability: 33
    }]
  };


___NOTES___

Created on 20/09/2019, 10:49:42


